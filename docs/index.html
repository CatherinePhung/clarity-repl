<!doctype html>
  <html>
    <head>
      <link rel='stylesheet' href='//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack-subset.css'>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css" />
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/xterm/2.9.2/xterm.min.css" />
      <script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/2.9.2/xterm.js"></script>
      <script src="https://cdn.rawgit.com/wavesoft/local-echo/7ee165d2c955fe07623b5d74f6dda3ae18815ba4/dist/local-echo.js"></script>
    </head>
    <body style="background-color: black; height: 100%; overflow: hidden;">
      <a class="github-fork-ribbon" href="http://github.com/lgalabru/clarity-repl" data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a> 
      <div id="terminal" style="position: absolute; top: 10px; bottom: 10px; right: 10px; left: 10px;"></div>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/2.9.2/addons/fit/fit.js"></script>
      <script>
        function findGetParameter(parameterName) {
          var result = null,
          tmp = [];
          var items = location.search.substr(1).split("&");
          for (var index = 0; index < items.length; index++) {
            tmp = items[index].split("=");
            if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
          }
          return result;
        }

        let wasm;
        let term = new Terminal({
          fontSize: 13,
          cursorBlink: true,
        });
        term.open(document.getElementById('terminal'), false);
        term.writeln('\x1B[1;3;30mConfiguring environement...\x1B[1;3;37m')
        let contractId = findGetParameter("fetch_contract");

        const editor = new LocalEchoController(term);
        const promptCommand = function() {
          editor.read(">> ", "   ")
            .then(input => {
              let snippet = input.replace(/\\/g, "");
              console.log(snippet);
              let result = handle_command(`${contractId}`, `${snippet}`);
              let lines = result.split("\n");
              for (line of lines) {
                term.writeln(line);
              }
              promptCommand();
            })  
            .catch(error => alert(`Error reading: ${error}`));
            term.focus();
        }

        term.writeln('\x1B[1;3;30mDownloading clarity_repl.wasm...\x1B[1;3;37m')

        fetch("http://127.0.0.1:8081/clarity_repl.wasm")
        // fetch("https://clarity-repl.s3.amazonaws.com/clarity_repl.wasm")
          .then(response => {
            term.writeln('\x1B[1;3;30mExtracting clarity_repl.wasm...\x1B[1;3;37m')
            return response.arrayBuffer();
          })
          .then(result => {
            term.writeln('\x1B[1;3;30mInstantiating binary...\x1B[1;3;37m');


            const imports = {};
            imports.wbg = {};
            imports.wbg.__wbindgen_json_serialize = function(arg0, arg1) {
                const obj = getObject(arg1);
                var ret = JSON.stringify(obj === undefined ? null : obj);
                var ptr0 = passStringToWasm0(ret, wasm.__wbindgen_malloc, wasm.__wbindgen_realloc);
                var len0 = WASM_VECTOR_LEN;
                getInt32Memory0()[arg0 / 4 + 1] = len0;
                getInt32Memory0()[arg0 / 4 + 0] = ptr0;
            };
            imports.wbg.__wbindgen_object_drop_ref = function(arg0) {
                takeObject(arg0);
            };
            imports.wbg.__wbindgen_cb_drop = function(arg0) {
                const obj = takeObject(arg0).original;
                if (obj.cnt-- == 1) {
                    obj.a = 0;
                    return true;
                }
                var ret = false;
                return ret;
            };
            imports.wbg.__wbindgen_is_undefined = function(arg0) {
                var ret = getObject(arg0) === undefined;
                return ret;
            };
            imports.wbg.__wbindgen_object_clone_ref = function(arg0) {
                var ret = getObject(arg0);
                return addHeapObject(ret);
            };
            imports.wbg.__wbindgen_string_new = function(arg0, arg1) {
                var ret = getStringFromWasm0(arg0, arg1);
                return addHeapObject(ret);
            };
            imports.wbg.__wbg_fetch_5274d89a348c0462 = function(arg0) {
                var ret = fetch(getObject(arg0));
                return addHeapObject(ret);
            };
            imports.wbg.__wbg_fetch_9dbf87b840590e85 = function(arg0, arg1) {
                var ret = getObject(arg0).fetch(getObject(arg1));
                return addHeapObject(ret);
            };
            imports.wbg.__wbg_new_80e79fe6852cbe9c = function() { return handleError(function () {
                var ret = new Headers();
                return addHeapObject(ret);
            }, arguments) };
            imports.wbg.__wbg_append_441dc2c4b2281095 = function() { return handleError(function (arg0, arg1, arg2, arg3, arg4) {
                getObject(arg0).append(getStringFromWasm0(arg1, arg2), getStringFromWasm0(arg3, arg4));
            }, arguments) };
            imports.wbg.__wbg_instanceof_Response_d61ff4c524b8dbc4 = function(arg0) {
                var ret = getObject(arg0) instanceof Response;
                return ret;
            };
            imports.wbg.__wbg_url_0ffe73d78f393423 = function(arg0, arg1) {
                var ret = getObject(arg1).url;
                var ptr0 = passStringToWasm0(ret, wasm.__wbindgen_malloc, wasm.__wbindgen_realloc);
                var len0 = WASM_VECTOR_LEN;
                getInt32Memory0()[arg0 / 4 + 1] = len0;
                getInt32Memory0()[arg0 / 4 + 0] = ptr0;
            };
            imports.wbg.__wbg_status_1a7d875f6e1318cd = function(arg0) {
                var ret = getObject(arg0).status;
                return ret;
            };
            imports.wbg.__wbg_headers_f49eca784c8ebeba = function(arg0) {
                var ret = getObject(arg0).headers;
                return addHeapObject(ret);
            };
            imports.wbg.__wbg_arrayBuffer_b7c95af83e1e2705 = function() { return handleError(function (arg0) {
                var ret = getObject(arg0).arrayBuffer();
                return addHeapObject(ret);
            }, arguments) };
            imports.wbg.__wbg_newwithstrandinit_155cb1478824b198 = function() { return handleError(function (arg0, arg1, arg2) {
                var ret = new Request(getStringFromWasm0(arg0, arg1), getObject(arg2));
                return addHeapObject(ret);
            }, arguments) };
            imports.wbg.__wbindgen_is_function = function(arg0) {
                var ret = typeof(getObject(arg0)) === 'function';
                return ret;
            };
            imports.wbg.__wbindgen_is_object = function(arg0) {
                const val = getObject(arg0);
                var ret = typeof(val) === 'object' && val !== null;
                return ret;
            };
            imports.wbg.__wbg_next_e38a92137a5693de = function(arg0) {
                var ret = getObject(arg0).next;
                return addHeapObject(ret);
            };
            imports.wbg.__wbg_done_86efa5ac73f5b194 = function(arg0) {
                var ret = getObject(arg0).done;
                return ret;
            };
            imports.wbg.__wbg_value_708ce1aa93862729 = function(arg0) {
                var ret = getObject(arg0).value;
                return addHeapObject(ret);
            };
            imports.wbg.__wbg_iterator_30586bd3e46ee10e = function() {
                var ret = Symbol.iterator;
                return addHeapObject(ret);
            };
            imports.wbg.__wbg_newnoargs_9fdd8f3961dd1bee = function(arg0, arg1) {
                var ret = new Function(getStringFromWasm0(arg0, arg1));
                return addHeapObject(ret);
            };
            imports.wbg.__wbg_call_ba36642bd901572b = function() { return handleError(function (arg0, arg1) {
                var ret = getObject(arg0).call(getObject(arg1));
                return addHeapObject(ret);
            }, arguments) };
            imports.wbg.__wbg_next_8b73f854755d8e5e = function() { return handleError(function (arg0) {
                var ret = getObject(arg0).next();
                return addHeapObject(ret);
            }, arguments) };
            imports.wbg.__wbg_new_edbe38a4e21329dd = function() {
                var ret = new Object();
                return addHeapObject(ret);
            };
            imports.wbg.__wbg_resolve_cae3d8f752f5db88 = function(arg0) {
                var ret = Promise.resolve(getObject(arg0));
                return addHeapObject(ret);
            };
            imports.wbg.__wbg_then_c2361a9d5c9a4fcb = function(arg0, arg1) {
                var ret = getObject(arg0).then(getObject(arg1));
                return addHeapObject(ret);
            };
            imports.wbg.__wbg_then_6c9a4bf55755f9b8 = function(arg0, arg1, arg2) {
                var ret = getObject(arg0).then(getObject(arg1), getObject(arg2));
                return addHeapObject(ret);
            };
            imports.wbg.__wbg_self_bb69a836a72ec6e9 = function() { return handleError(function () {
                var ret = self.self;
                return addHeapObject(ret);
            }, arguments) };
            imports.wbg.__wbg_window_3304fc4b414c9693 = function() { return handleError(function () {
                var ret = window.window;
                return addHeapObject(ret);
            }, arguments) };
            imports.wbg.__wbg_globalThis_e0d21cabc6630763 = function() { return handleError(function () {
                var ret = globalThis.globalThis;
                return addHeapObject(ret);
            }, arguments) };
            imports.wbg.__wbg_global_8463719227271676 = function() { return handleError(function () {
                var ret = global.global;
                return addHeapObject(ret);
            }, arguments) };
            imports.wbg.__wbg_buffer_9e184d6f785de5ed = function(arg0) {
                var ret = getObject(arg0).buffer;
                return addHeapObject(ret);
            };
            imports.wbg.__wbg_newwithbyteoffsetandlength_e57ad1f2ce812c03 = function(arg0, arg1, arg2) {
                var ret = new Uint8Array(getObject(arg0), arg1 >>> 0, arg2 >>> 0);
                return addHeapObject(ret);
            };
            imports.wbg.__wbg_new_e8101319e4cf95fc = function(arg0) {
                var ret = new Uint8Array(getObject(arg0));
                return addHeapObject(ret);
            };
            imports.wbg.__wbg_set_e8ae7b27314e8b98 = function(arg0, arg1, arg2) {
                getObject(arg0).set(getObject(arg1), arg2 >>> 0);
            };
            imports.wbg.__wbg_length_2d56cb37075fcfb1 = function(arg0) {
                var ret = getObject(arg0).length;
                return ret;
            };
            imports.wbg.__wbg_get_800098c980b31ea2 = function() { return handleError(function (arg0, arg1) {
                var ret = Reflect.get(getObject(arg0), getObject(arg1));
                return addHeapObject(ret);
            }, arguments) };
            imports.wbg.__wbg_has_9fa0c068863afd36 = function() { return handleError(function (arg0, arg1) {
                var ret = Reflect.has(getObject(arg0), getObject(arg1));
                return ret;
            }, arguments) };
            imports.wbg.__wbg_set_73349fc4814e0fc6 = function() { return handleError(function (arg0, arg1, arg2) {
                var ret = Reflect.set(getObject(arg0), getObject(arg1), getObject(arg2));
                return ret;
            }, arguments) };
            imports.wbg.__wbindgen_debug_string = function(arg0, arg1) {
                var ret = debugString(getObject(arg1));
                var ptr0 = passStringToWasm0(ret, wasm.__wbindgen_malloc, wasm.__wbindgen_realloc);
                var len0 = WASM_VECTOR_LEN;
                getInt32Memory0()[arg0 / 4 + 1] = len0;
                getInt32Memory0()[arg0 / 4 + 0] = ptr0;
            };
            imports.wbg.__wbindgen_throw = function(arg0, arg1) {
                throw new Error(getStringFromWasm0(arg0, arg1));
            };
            imports.wbg.__wbindgen_memory = function() {
                var ret = wasm.memory;
                return addHeapObject(ret);
            };
            imports.wbg.__wbindgen_closure_wrapper5799 = function(arg0, arg1, arg2) {
                var ret = makeMutClosure(arg0, arg1, 1550, __wbg_adapter_24);
                return addHeapObject(ret);
            };

            return WebAssembly.instantiate(result, imports);
          })
          .then(repl_backend => {
            wasm = repl_backend.instance.exports;
            term.reset();
            console.log(this.fit);
            term.fit();
            term.writeln('\x1B[1;3;32mclarity-repl v0.11.0')
            term.writeln('\x1B[1;3;30mEnter \"::help\" for usage hints.')
            term.writeln('\x1B[1;3;30mConnected to a transient in-memory database.\x1B[1;3;37m')
            term.writeln(`\x1B[1;3;30mLoading contract ${contractId}.\x1B[1;3;37m`)
            promptCommand();
          });

        let WASM_VECTOR_LEN = 0;

        let cachegetUint8Memory0 = null;
        function getUint8Memory0() {
            if (cachegetUint8Memory0 === null || cachegetUint8Memory0.buffer !== wasm.memory.buffer) {
                cachegetUint8Memory0 = new Uint8Array(wasm.memory.buffer);
            }
            return cachegetUint8Memory0;
        }

        let cachedTextEncoder = new TextEncoder('utf-8');

        const encodeString = (typeof cachedTextEncoder.encodeInto === 'function'
            ? function (arg, view) {
            return cachedTextEncoder.encodeInto(arg, view);
        }
            : function (arg, view) {
            const buf = cachedTextEncoder.encode(arg);
            view.set(buf);
            return {
                read: arg.length,
                written: buf.length
            };
        });

        function passStringToWasm0(arg, malloc, realloc) {

            if (realloc === undefined) {
                const buf = cachedTextEncoder.encode(arg);
                const ptr = malloc(buf.length);
                getUint8Memory0().subarray(ptr, ptr + buf.length).set(buf);
                WASM_VECTOR_LEN = buf.length;
                return ptr;
            }

            let len = arg.length;
            let ptr = malloc(len);

            const mem = getUint8Memory0();

            let offset = 0;

            for (; offset < len; offset++) {
                const code = arg.charCodeAt(offset);
                if (code > 0x7F) break;
                mem[ptr + offset] = code;
            }

            if (offset !== len) {
                if (offset !== 0) {
                    arg = arg.slice(offset);
                }
                ptr = realloc(ptr, len, len = offset + arg.length * 3);
                const view = getUint8Memory0().subarray(ptr + offset, ptr + len);
                const ret = encodeString(arg, view);

                offset += ret.written;
            }

            WASM_VECTOR_LEN = offset;
            return ptr;
        }

        let cachegetInt32Memory0 = null;
        function getInt32Memory0() {
            if (cachegetInt32Memory0 === null || cachegetInt32Memory0.buffer !== wasm.memory.buffer) {
                cachegetInt32Memory0 = new Int32Array(wasm.memory.buffer);
            }
            return cachegetInt32Memory0;
        }

        let cachedTextDecoder = new TextDecoder('utf-8', { ignoreBOM: true, fatal: true });

        cachedTextDecoder.decode();

        function getStringFromWasm0(ptr, len) {
            return cachedTextDecoder.decode(getUint8Memory0().subarray(ptr, ptr + len));
        }

        function handle_command(fetch_contract, command) {
            try {
                const retptr = wasm.__wbindgen_add_to_stack_pointer(-16);
                var ptr0 = passStringToWasm0(fetch_contract, wasm.__wbindgen_malloc, wasm.__wbindgen_realloc);
                var len0 = WASM_VECTOR_LEN;
                var ptr1 = passStringToWasm0(command, wasm.__wbindgen_malloc, wasm.__wbindgen_realloc);
                var len1 = WASM_VECTOR_LEN;
                wasm.handle_command(retptr, ptr0, len0, ptr1, len1);
                var r0 = getInt32Memory0()[retptr / 4 + 0];
                var r1 = getInt32Memory0()[retptr / 4 + 1];
                return getStringFromWasm0(r0, r1);
            } finally {
                wasm.__wbindgen_add_to_stack_pointer(16);
                wasm.__wbindgen_free(r0, r1);
            }
        }
      </script> 
    </body>
  </html>